<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:EstForge.Core.ViewModels;assembly=EstForge.Core"
             xmlns:models="clr-namespace:EstForge.Data.Models;assembly=EstForge.Data"
             xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
             xmlns:converters="clr-namespace:EstForge.MAUI.Converters"
             x:Class="EstForge.MAUI.MainPage"
             x:Name="mainPage"
             x:DataType="vm:MainViewModel"
             Shell.NavBarIsVisible="False"
             BackgroundColor="#D1DCE5">

    <ContentPage.Resources>
        <ResourceDictionary>
            <!-- Converter per visibilitÃ  -->
            <toolkit:InvertedBoolConverter x:Key="InvertedBoolConverter" />

            <!-- Custom Converters -->
            <converters:GuidEqualsConverter x:Key="GuidEqualsConverter" />
            <converters:GuidEqualsMultiConverter x:Key="GuidEqualsMultiConverter" />
            <converters:IsGreaterThanZeroConverter x:Key="IsGreaterThanZeroConverter" />
            <converters:NotGreaterThanZeroConverter x:Key="NotGreaterThanZeroConverter" />
            <converters:StringNotNullOrEmptyConverter x:Key="StringNotNullOrEmptyConverter" />
            <converters:StringIsNullOrEmptyConverter x:Key="StringIsNullOrEmptyConverter" />
            <converters:AllTrueMultiConverter x:Key="AllTrueMultiConverter" />
            <converters:NoneMultiConverter x:Key="NoneMultiConverter" />

            <!-- Stile Glass Card -->
            <Style x:Key="GlassCard" TargetType="Frame">
                <Setter Property="BackgroundColor" Value="White" />
                <Setter Property="HasShadow" Value="True" />
                <Setter Property="CornerRadius" Value="16" />
                <Setter Property="Padding" Value="16" />
                <Setter Property="BorderColor" Value="#E0E0E0" />
            </Style>
        </ResourceDictionary>
    </ContentPage.Resources>

    <ScrollView>
        <VerticalStackLayout Spacing="12" Padding="16">

            <!-- HEADER CARD 1: Gestione Preventivi -->
            <Frame Style="{StaticResource GlassCard}" Padding="16">
                <Label Text="Gestione Preventivi"
                       FontSize="36"
                       FontAttributes="Bold"
                       TextColor="#1F2937"
                       HorizontalOptions="Center"/>
            </Frame>

            <!-- HEADER CARD 2: Logo Aziendale -->
            <Frame Style="{StaticResource GlassCard}"
                   Padding="8"
                   HorizontalOptions="Center"
                   WidthRequest="200"
                   HeightRequest="150">
                <Label Text="ðŸ“„"
                       FontSize="80"
                       HorizontalOptions="Center"
                       VerticalOptions="Center"/>
            </Frame>

            <!-- HEADER CARD 3: Info Azienda -->
            <Frame Style="{StaticResource GlassCard}" Padding="16">
                <Grid ColumnDefinitions="Auto,*" ColumnSpacing="20">
                    <Label Grid.Column="0"
                           Text="{Binding CompanyName}"
                           FontSize="28"
                           FontAttributes="Bold"
                           TextColor="#1F2937"
                           VerticalOptions="Center"/>

                    <VerticalStackLayout Grid.Column="1"
                                        Spacing="4"
                                        VerticalOptions="Center"
                                        HorizontalOptions="End">
                        <Label Text="P.IVA 01234567890"
                               FontSize="12"
                               TextColor="#6B7280"
                               HorizontalTextAlignment="End"/>
                        <Label Text="Sede legale: Via Roma 1, Milano (MI)"
                               FontSize="12"
                               TextColor="#6B7280"
                               HorizontalTextAlignment="End"/>
                        <Label Text="Tel. +39 02 123456 â€¢ email: info@zetaforge.it"
                               FontSize="12"
                               TextColor="#6B7280"
                               HorizontalTextAlignment="End"/>
                    </VerticalStackLayout>
                </Grid>
            </Frame>

            <!-- SEARCH BAR + NUOVO BUTTON -->
            <Frame Style="{StaticResource GlassCard}" Padding="12">
                <Grid ColumnDefinitions="*,Auto" ColumnSpacing="12">
                    <SearchBar Grid.Column="0"
                              Placeholder="Cerca numero preventivo, cliente o indirizzo..."
                              Text="{Binding SearchText}"
                              BackgroundColor="#F9FAFB"
                              HeightRequest="48"/>

                    <Button Grid.Column="1"
                            Text="+ Nuovo preventivo"
                            Command="{Binding NavigateToCreateCommand}"
                            BackgroundColor="#3B82F6"
                            TextColor="White"
                            CornerRadius="12"
                            Padding="20,0"
                            HeightRequest="48"
                            FontAttributes="Bold"
                            FontSize="14"/>
                </Grid>
            </Frame>

            <!-- LISTA PREVENTIVI -->
            <Frame Style="{StaticResource GlassCard}" Padding="12">
                <CollectionView ItemsSource="{Binding FilteredPreventivi}"
                               SelectionMode="None">

                    <CollectionView.EmptyView>
                        <VerticalStackLayout VerticalOptions="Center"
                                            HorizontalOptions="Center"
                                            Spacing="16"
                                            Margin="0,60,0,0">
                            <Label Text="ðŸ“‹"
                                   FontSize="72"
                                   HorizontalOptions="Center"/>
                            <Label Text="{Binding SearchText, StringFormat='Nessun preventivo trovato per &quot;{0}&quot;'}"
                                   FontSize="16"
                                   TextColor="#6B7280"
                                   HorizontalOptions="Center"
                                   IsVisible="{Binding SearchText, Converter={StaticResource StringNotNullOrEmptyConverter}}"/>
                            <Label Text="Nessun preventivo presente. Creane uno nuovo!"
                                   FontSize="16"
                                   TextColor="#6B7280"
                                   HorizontalOptions="Center"
                                   IsVisible="{Binding SearchText, Converter={StaticResource StringIsNullOrEmptyConverter}}"/>
                        </VerticalStackLayout>
                    </CollectionView.EmptyView>

                    <CollectionView.ItemTemplate>
                        <DataTemplate x:DataType="models:Preventivo">
                            <Frame BackgroundColor="White"
                                   CornerRadius="12"
                                   Padding="16"
                                   Margin="0,0,0,8"
                                   HasShadow="True">

                                <Grid ColumnDefinitions="Auto,*,Auto"
                                      ColumnSpacing="16">

                                    <!-- ICONA DOCUMENTO -->
                                    <Frame Grid.Column="0"
                                           BackgroundColor="#EFF6FF"
                                           BorderColor="#BFDBFE"
                                           CornerRadius="12"
                                           Padding="12"
                                           HasShadow="False"
                                           WidthRequest="56"
                                           HeightRequest="56">
                                        <Label Text="ðŸ“„"
                                               FontSize="28"
                                               VerticalOptions="Center"
                                               HorizontalOptions="Center"/>
                                    </Frame>

                                    <!-- INFO PREVENTIVO -->
                                    <VerticalStackLayout Grid.Column="1"
                                                        Spacing="4"
                                                        VerticalOptions="Center">
                                        <Label FontSize="18"
                                               FontAttributes="Bold"
                                               TextColor="#1F2937">
                                            <Label.FormattedText>
                                                <FormattedString>
                                                    <Span Text="{Binding Numero, StringFormat='{0:D2}'}" />
                                                    <Span Text="-" />
                                                    <Span Text="{Binding Anno}" />
                                                    <Span Text=" " />
                                                    <Span Text="{Binding Cliente.NomeRagioneSociale}" />
                                                </FormattedString>
                                            </Label.FormattedText>
                                        </Label>

                                        <Label Text="{Binding UbicazioneVia}"
                                               FontSize="14"
                                               TextColor="#6B7280"
                                               LineBreakMode="TailTruncation"/>
                                    </VerticalStackLayout>

                                    <!-- BOTTONI AZIONI -->
                                    <HorizontalStackLayout Grid.Column="2"
                                                          Spacing="8"
                                                          VerticalOptions="Center"
                                                          HorizontalOptions="End">
                                        <HorizontalStackLayout.IsVisible>
                                            <MultiBinding Converter="{StaticResource NoneMultiConverter}">
                                                <Binding Path="BindingContext.IsSelectionMode" Source="{x:Reference mainPage}" />
                                                <MultiBinding Converter="{StaticResource GuidEqualsMultiConverter}">
                                                    <Binding Path="BindingContext.InfoQuoteId" Source="{x:Reference mainPage}" />
                                                    <Binding Path="Id" />
                                                </MultiBinding>
                                            </MultiBinding>
                                        </HorizontalStackLayout.IsVisible>

                                        <!-- Info Button -->
                                        <Button Text="â„¹ï¸ Info"
                                                Command="{Binding Path=BindingContext.ToggleInfoCommand, Source={x:Reference mainPage}}"
                                                CommandParameter="{Binding Id}"
                                                BackgroundColor="#3B82F6"
                                                TextColor="White"
                                                CornerRadius="8"
                                                Padding="12,6"
                                                FontSize="12"
                                                FontAttributes="Bold"/>

                                        <!-- Clona Button -->
                                        <Button Text="ðŸ“‹ Clona"
                                                Command="{Binding Path=BindingContext.NavigateToCloneQuoteCommand, Source={x:Reference mainPage}}"
                                                CommandParameter="{Binding .}"
                                                BackgroundColor="#10B981"
                                                TextColor="White"
                                                CornerRadius="8"
                                                Padding="12,6"
                                                FontSize="12"
                                                FontAttributes="Bold"/>

                                        <!-- Modifica NÂ°/Anno Button -->
                                        <Button Text="âœï¸ Modifica NÂ°/Anno"
                                                Command="{Binding Path=BindingContext.NavigateToEditQuoteNumberCommand, Source={x:Reference mainPage}}"
                                                CommandParameter="{Binding .}"
                                                BackgroundColor="#A855F7"
                                                TextColor="White"
                                                CornerRadius="8"
                                                Padding="12,6"
                                                FontSize="12"
                                                FontAttributes="Bold"/>

                                        <!-- Modifica Button -->
                                        <Button Text="ðŸ–Šï¸ Modifica"
                                                Command="{Binding Path=BindingContext.NavigateToEditQuoteCommand, Source={x:Reference mainPage}}"
                                                CommandParameter="{Binding .}"
                                                BackgroundColor="#3B82F6"
                                                TextColor="White"
                                                CornerRadius="8"
                                                Padding="12,6"
                                                FontSize="12"
                                                FontAttributes="Bold"/>

                                        <!-- Elimina Button -->
                                        <Button Text="ðŸ—‘ï¸ Elimina"
                                                Command="{Binding Path=BindingContext.DeletePreventivoCommand, Source={x:Reference mainPage}}"
                                                CommandParameter="{Binding Id}"
                                                BackgroundColor="#EF4444"
                                                TextColor="White"
                                                CornerRadius="8"
                                                Padding="12,6"
                                                FontSize="12"
                                                FontAttributes="Bold"/>
                                    </HorizontalStackLayout>

                                    <!-- INFO PANEL (OGGETTO E TOTALE) -->
                                    <Grid Grid.Column="2"
                                          ColumnDefinitions="*,Auto"
                                          ColumnSpacing="16"
                                          VerticalOptions="Center"
                                          HorizontalOptions="End">
                                        <Grid.IsVisible>
                                            <MultiBinding Converter="{StaticResource GuidEqualsMultiConverter}">
                                                <Binding Path="BindingContext.InfoQuoteId" Source="{x:Reference mainPage}" />
                                                <Binding Path="Id" />
                                            </MultiBinding>
                                        </Grid.IsVisible>
                                        <Label Grid.Column="0"
                                               FontSize="14"
                                               TextColor="#2563EB"
                                               FontAttributes="Bold"
                                               LineBreakMode="TailTruncation">
                                            <Label.FormattedText>
                                                <FormattedString>
                                                    <Span Text="Oggetto: " />
                                                    <Span Text="{Binding Oggetto}" />
                                                </FormattedString>
                                            </Label.FormattedText>
                                        </Label>
                                        <Label Grid.Column="1"
                                               Text="{Binding Totale, StringFormat='â‚¬ {0:N2}'}"
                                               FontSize="14"
                                               TextColor="#1F2937"
                                               FontAttributes="Bold"/>
                                    </Grid>

                                </Grid>
                            </Frame>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>
            </Frame>

            <!-- BOTTOM ACTION BUTTONS -->
            <Grid ColumnDefinitions="*,*" ColumnSpacing="12" RowDefinitions="Auto,Auto" RowSpacing="12">

                <!-- Row 0 - Prima riga bottoni -->
                <Button Grid.Row="0" Grid.Column="0"
                        Text="ðŸ“ Nuovo Preventivo Personalizzato"
                        Command="{Binding NavigateToCustomQuoteCommand}"
                        BackgroundColor="#3B82F6"
                        TextColor="White"
                        CornerRadius="12"
                        Padding="16"
                        HeightRequest="56"
                        FontAttributes="Bold"
                        FontSize="14"
                        IsVisible="{Binding SelectedCount, Converter={StaticResource NotGreaterThanZeroConverter}}"/>

                <Button Grid.Row="0" Grid.Column="1"
                        Text="â˜‘ï¸ Seleziona preventivi"
                        Command="{Binding ToggleSelectionModeCommand}"
                        BackgroundColor="#3B82F6"
                        TextColor="White"
                        CornerRadius="12"
                        Padding="16"
                        HeightRequest="56"
                        FontAttributes="Bold"
                        FontSize="14"
                        IsVisible="{Binding SelectedCount, Converter={StaticResource NotGreaterThanZeroConverter}}"/>

                <!-- Row 1 - Seconda riga bottoni -->
                <Button Grid.Row="1" Grid.Column="0"
                        Text="ðŸ”„ Recupera Lavoro"
                        Command="{Binding NavigateToRecoverWorkCommand}"
                        BackgroundColor="#3B82F6"
                        TextColor="White"
                        CornerRadius="12"
                        Padding="16"
                        HeightRequest="56"
                        FontAttributes="Bold"
                        FontSize="14"/>

                <Button Grid.Row="1" Grid.Column="1"
                        Text="âš™ï¸ Impostazioni"
                        Command="{Binding NavigateToSettingsCommand}"
                        BackgroundColor="#3B82F6"
                        TextColor="White"
                        CornerRadius="12"
                        Padding="16"
                        HeightRequest="56"
                        FontAttributes="Bold"
                        FontSize="14"/>
            </Grid>

            <!-- LOADING OVERLAY -->
            <Grid IsVisible="{Binding IsBusy}"
                  BackgroundColor="#80000000"
                  Padding="100">
                <ActivityIndicator IsRunning="{Binding IsBusy}"
                                  Color="White"
                                  WidthRequest="60"
                                  HeightRequest="60"/>
            </Grid>

        </VerticalStackLayout>
    </ScrollView>

</ContentPage>
